import org.openhab.core.library.types.*
import org.openhab.core.persistence.*
import org.openhab.model.script.actions.*
import java.lang.Double

var Timer timerMv
var Number departureMinutesAfterMidnight

rule "Initialize startup"
when
	System started
then
	// Delay init to make sure persistance restoration has been done
	createTimer(now.plusSeconds(5)) [|
		logInfo("openhab startup timer init...", "disable/enable all to last state")
		departureMinutesAfterMidnight = 0
		gBelysning?.members.forEach(light | sendCommand(light, light.state as OnOffType))
		sendCommand(GarageOutlet, GarageOutlet.state as OnOffType)
	]
end


rule "Rule at sunset"
when
    Item Sunset_Event_Offset received update ON
then
    logInfo("Sun is going away...", "Time: " + Sunset_Time)

    // Light On more group
    gMoreLightOn?.members.forEach(light | sendCommand(light, ON))

    var lessLimit = now.getYear + "-" + now.getMonthOfYear + "-" + now.getDayOfMonth + "T20:00:00"

    // Do not turn on light in lesser light group if after 20 in evening
    if (parse(lessLimit).afterNow) {
		  gLesserLightOn?.members.forEach(light | sendCommand(light, ON))
    }
end

rule "Rule at sunrise"
when
    Item Sunrise_Event_Offset received update ON
then
    logInfo("Sun is rising...", "Time: " + Sunrise_Time)

    gBelysning?.members.forEach(light | sendCommand(light, OFF))
end

rule "Turn off lights in the night"
when
	Time cron "0 59 23 * * ?"
then
	// Omit the lights in the night lights group
    gBelysning?.members.forEach(light | if (!gNightLights?.members.contains(light)) sendCommand(light, OFF))
end

rule "Turn on winter morning lights"
when
	Time cron "0 10 6 * * ?"
then
	var month = now.getMonthOfYear()
	if (month < 3 || month > 9) {
	    gMoreLightOn?.members.forEach(light | sendCommand(light, ON))
	}
end

rule "Turn on Mv dynamically week days depending of temperature"
when
	Time cron "0 1/5 3-8 ? * MON-FRI *"
	//Time cron "10/10 * 19-22 * * ?"
then
	// We have a dynamic setting
	if (departureMinutesAfterMidnight > 0) {
		var departure = now.toLocalDate.toDateTimeAtStartOfDay.plusMinutes(departureMinutesAfterMidnight.intValue)
		
		// Move start time back depending of temperature
		var start = departure.plusMinutes(-20); // Add 20 minutes as default
		
		var int temp = (Ute_Temp.state as DecimalType).intValue
		if (temp < 0) {
			start = start.plusMinutes(6 * temp)
		}

		//logInfo("times", "start: " + start + " departure: " + departure + " now: " + now)

		// Time to turn on?
		if (start.beforeNow && departure.afterNow) {
			// Only start if not already active
			if ((GarageOutlet.state as OnOffType) == OFF) {
				logInfo("Turning on Mv", "Temperature outside: " + Ute_Temp.state)
				
				sendCommand(GarageOutlet, ON)
		
				// Turn off after 3 hours
				timerMv = createTimer(now.plusMinutes(180)) [|
					sendCommand(GarageOutlet, OFF)
			]
			}
		}
		
	}
end


rule "Turn on Mv weekday mornings"
when
	Item MvWeekDaysDynamic received command
then
	departureMinutesAfterMidnight = (receivedCommand as DecimalType / 10 * 60).intValue

	if (departureMinutesAfterMidnight > 0) {
		postUpdate(MvStatus, "Dynamisk")
	} else {
		postUpdate(MvStatus, "Nollställd")
	}

end


rule "Turn on Mv now"
when
	Item MvTimerNow received command
then
	if (timerMv != null) {
		timerMv.cancel
		timerMv = null
	}

	/*
	 * Sample event triggering
	 sendCommand(Sunset_Event_Offset, ON)
	 *
	 */

	sendCommand(GarageOutlet, ON)

	var minutes = (receivedCommand as DecimalType).intValue

	timerMv = createTimer(now.plusMinutes(minutes)) [|
		sendCommand(GarageOutlet, OFF)
	]

	postUpdate(MvStatus, "Aktiv")
	postUpdate(MvTimerDelay, 0)
	postUpdate(MvTimerStart, 0)

	logInfo("Timer OFF in minutes...", "" + minutes)
end

rule "Turn on Mv delayed"
when
	Item MvTimerDelay received command
then
	if (timerMv != null) {
		timerMv.cancel
		timerMv = null
	}

	sendCommand(GarageOutlet, OFF)

	var minutes = (receivedCommand as DecimalType).intValue

	timerMv = createTimer(now.plusMinutes(minutes)) [|
		sendCommand(GarageOutlet, ON)

		// Turn off after 2 hours
		timerMv = createTimer(now.plusMinutes(120)) [|
			sendCommand(GarageOutlet, OFF)
		]
	]

	postUpdate(MvStatus, "Fördröjd")
	postUpdate(MvTimerNow, 0)
	postUpdate(MvTimerStart, 0)

	logInfo("Time ON in minutes...", "" + minutes)
end

rule "Turn on Mv start"
when
	Item MvTimerStart received command
then
	if (timerMv != null) {
		timerMv.cancel
		timerMv = null
	}

	sendCommand(GarageOutlet, OFF)

	var minutesAfterMidnight = (receivedCommand as DecimalType / 10 * 60).intValue

	var start = now.toLocalDate.plusDays(1).toDateTimeAtStartOfDay.plusMinutes(minutesAfterMidnight)

	timerMv = createTimer(start) [|
		sendCommand(GarageOutlet, ON)

		// Turn off after 2 hours
		timerMv = createTimer(now.plusMinutes(120)) [|
			sendCommand(GarageOutlet, OFF)
		]
	]

	postUpdate(MvStatus, "Starttid " + start.getHourOfDay + ":" + start.getMinuteOfHour)
	postUpdate(MvTimerNow, 0)
	postUpdate(MvTimerDelay, 0)

	logInfo("Time ON tomorrow at...", "" + start)
end

rule "Mv Zero"
when
	Item GarageOutlet received command OFF
then
	if (timerMv != null) {
		timerMv.cancel
		timerMv = null
	}

	if (departureMinutesAfterMidnight > 0) {
		postUpdate(MvStatus, "Dynamisk")	
	} else {
		postUpdate(MvStatus, "Nollställd")
	}
	
	postUpdate(MvTimerNow, 0)
	postUpdate(MvTimerDelay, 0)
	postUpdate(MvTimerStart, 0)

	logInfo("Zero out...", "")
end
